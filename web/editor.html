<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pseudo++</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-hard: #1d2021;
      --bg: #282828;
      --bg-soft: #32302f;
      --bg1: #3c3836;
      --bg2: #504945;
      --bg3: #665c54;
      --bg4: #7c6f64;
      --fg: #ebdbb2;
      --fg2: #d5c4a1;
      --fg3: #bdae93;
      --fg4: #a89984;
      --gray: #928374;
      --red: #fb4934;
      --red-dim: #cc241d;
      --green: #b8bb26;
      --green-dim: #98971a;
      --yellow: #fabd2f;
      --yellow-dim: #d79921;
      --blue: #83a598;
      --blue-dim: #458588;
      --purple: #d3869b;
      --purple-dim: #b16286;
      --aqua: #8ec07c;
      --aqua-dim: #689d6a;
      --orange: #fe8019;
      --orange-dim: #d65d0e;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--fg);
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: var(--bg);
      border-bottom: 1px solid var(--bg1);
      flex-shrink: 0;
    }

    .toolbar-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toolbar-title span:first-child {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .toolbar-title span:last-child {
      font-size: 0.75rem;
      color: var(--bg3);
    }

    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      border: none;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s, color 0.15s;
    }

    .btn-run {
      background: transparent;
      color: var(--green);
      padding: 0.5rem;
    }

    .btn-run:hover {
      background: var(--bg1);
      color: var(--green);
    }

    .btn-debug {
      background: transparent;
      color: var(--fg4);
      padding: 0.5rem;
    }

    .btn-debug:hover {
      background: var(--bg1);
      color: var(--yellow);
    }

    .btn-stop {
      background: transparent;
      color: var(--red);
      padding: 0.5rem;
    }

    .btn-stop:hover {
      background: var(--bg1);
      color: var(--red);
    }

    .btn-icon {
      padding: 0.5rem;
      background: transparent;
      color: var(--fg4);
    }

    .btn-icon:hover {
      background: var(--bg1);
      color: var(--fg);
    }

    .debug-indicator {
      margin-left: 0.5rem;
      font-size: 0.75rem;
      color: var(--yellow);
    }

    /* Main container */
    .main {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    /* Editor panel */
    .editor-panel {
      display: flex;
      flex-direction: column;
      min-width: 200px;
      background: var(--bg-hard);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0 0.5rem;
      background: var(--bg);
      border-bottom: 1px solid var(--bg1);
      font-size: 0.75rem;
      min-height: 36px;
    }

    .panel-header-title {
      color: var(--fg4);
    }

    .panel-header-status {
      color: var(--green);
    }

    /* File tabs */
    .file-tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: none;
      border-radius: 4px 4px 0 0;
      font-family: inherit;
      font-size: 0.75rem;
      color: var(--fg4);
      cursor: pointer;
      transition: background-color 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .file-tab:hover {
      background: var(--bg-soft);
      color: var(--fg2);
    }

    .file-tab.active {
      background: var(--bg-hard);
      color: var(--fg);
    }

    .file-tab-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 2px;
      color: var(--fg4);
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s, background-color 0.15s;
    }

    .file-tab:hover .file-tab-close,
    .file-tab.active .file-tab-close {
      opacity: 1;
    }

    .file-tab-close:hover {
      background: var(--bg2);
      color: var(--fg);
    }

    .file-tabs-wrapper {
      display: flex;
      align-items: center;
      max-width: calc(100% - 60px);
      overflow: hidden;
    }

    .tabs-scroll-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 28px;
      padding: 0;
      background: var(--bg);
      border: none;
      color: var(--fg4);
      cursor: pointer;
      flex-shrink: 0;
    }

    .tabs-scroll-btn:hover {
      color: var(--fg);
      background: var(--bg-soft);
    }

    .tabs-scroll-btn.visible {
      display: flex;
    }

    .file-tabs {
      display: flex;
      align-items: center;
      gap: 2px;
      overflow-x: auto;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }

    .add-file-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 4px;
      color: var(--fg4);
      cursor: pointer;
      transition: background-color 0.15s, color 0.15s;
      flex-shrink: 0;
    }

    .add-file-btn:hover {
      background: var(--bg-soft);
      color: var(--fg);
    }

    #editor-container {
      flex: 1;
      min-height: 0;
    }

    /* Resize handle */
    .resize-handle {
      width: 4px;
      background: var(--bg1);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background-color 0.15s;
    }

    .resize-handle:hover,
    .resize-handle.dragging {
      background: var(--blue);
    }

    /* Console panel */
    .console-panel {
      display: flex;
      flex-direction: column;
      min-width: 200px;
      background: var(--bg-hard);
    }

    .console-panel .panel-header {
      justify-content: space-between;
    }

    .console-output {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      font-size: 0.875rem;
      line-height: 1.5;
      cursor: text;
      scrollbar-width: none;
    }

    .console-output::-webkit-scrollbar {
      display: none;
    }

    .console-line {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .console-line.output { color: var(--fg); }
    .console-line.input { color: var(--blue); }
    .console-line.error { color: var(--red); }
    .console-line.system { color: var(--gray); }
    .console-line.debug { color: var(--yellow); }

    .console-line.input::before {
      content: '< ';
      color: var(--blue);
    }

    .console-line.debug::before {
      content: '[DEBUG] ';
      color: var(--yellow);
    }

    .console-placeholder {
      color: var(--bg3);
    }

    .input-line {
      display: flex;
      align-items: center;
    }

    .input-prompt {
      color: var(--green);
    }

    .console-input {
      flex: 1;
      margin-left: 0.25rem;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: inherit;
      color: var(--fg);
      caret-color: var(--fg);
    }

    .cursor-blink {
      animation: blink 1s step-end infinite;
      color: var(--fg);
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Icons */
    .icon {
      width: 16px;
      height: 16px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .icon-lg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <div class="toolbar-title">
        <span>Pseudo++</span>
        <span id="version-label"></span>
      </div>
      <div class="toolbar-actions">
        <button id="btn-run" class="btn btn-run" title="Run">
          <svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6 4 20 12 6 20 6 4"></polygon></svg>
        </button>
        <button id="btn-debug" class="btn btn-debug" title="Debug">
          <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7a4 4 0 1 1 8 0v2H8V7z"></path><path d="M6 12h12"></path><path d="M6 16h12"></path><rect x="7" y="10" width="10" height="10" rx="2"></rect><path d="M5 10l-2-1"></path><path d="M19 10l2-1"></path><path d="M5 16l-2 1"></path><path d="M19 16l2 1"></path></svg>
        </button>
        <button id="btn-stop" class="btn btn-stop" title="Stop" style="display: none;">
          <svg class="icon icon-lg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>
        </button>
        <span id="debug-indicator" class="debug-indicator" style="display: none;">Debug mode</span>
        <a href="docs.html" target="_blank" class="btn btn-icon" title="Documentație">
          <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </a>
      </div>
    </div>

    <div class="main">
      <div class="editor-panel" id="editor-panel">
        <div class="panel-header">
          <div class="file-tabs-wrapper">
            <button class="tabs-scroll-btn" id="tabs-scroll-left" title="Scroll left">
              <svg class="icon" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
            </button>
            <div class="file-tabs" id="file-tabs"></div>
            <button class="tabs-scroll-btn" id="tabs-scroll-right" title="Scroll right">
              <svg class="icon" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"></path></svg>
            </button>
            <button class="add-file-btn" id="add-file-btn" title="New file">
              <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
            </button>
          </div>
          <span id="run-status" class="panel-header-status"></span>
        </div>
        <div id="editor-container"></div>
      </div>

      <div class="resize-handle" id="resize-handle"></div>

      <div class="console-panel" id="console-panel">
        <div class="panel-header">
          <span class="panel-header-title">Console</span>
          <button id="btn-clear" class="btn btn-icon" title="Clear console">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4 4l16 16M4 20L20 4"></path></svg>
          </button>
        </div>
        <div class="console-output" id="console-output">
          <div class="console-placeholder">$ ready</div>
        </div>
      </div>
    </div>
  </div>

  <script src="version.js"></script>
  <script src="pseudo.js"></script>
  <script src="wasm-runner.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    // Set version from version.js
    document.getElementById('version-label').textContent = VERSION;

    // State
    let editor = null;
    let pseudoInterpreter = null;
    let isRunning = false;
    let isDebugging = false;
    let isWaitingForInput = false;
    let inputCallback = null;
    let stopRequested = false;
    let editorWidth = 60; // percentage

    // File system state
    let files = [];
    let activeFileId = null;
    let fileCounter = 0;

    // LocalStorage persistence
    const STORAGE_KEY = 'pseudo_editor_state';

    function saveState() {
      // Save current editor content to active file first
      if (activeFileId && editor) {
        const currentFile = files.find(f => f.id === activeFileId);
        if (currentFile) {
          currentFile.content = editor.getValue();
        }
      }
      const state = {
        files: files,
        activeFileId: activeFileId,
        editorWidth: editorWidth,
        fileCounter: fileCounter
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Failed to save state:', e);
      }
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.warn('Failed to parse saved state:', e);
        }
      }
      return null;
    }

    // Debounced save for content changes
    let saveTimeout = null;
    function debouncedSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveState, 1000);
    }

    // DOM Elements
    const btnRun = document.getElementById('btn-run');
    const btnDebug = document.getElementById('btn-debug');
    const btnStop = document.getElementById('btn-stop');
    const btnClear = document.getElementById('btn-clear');
    const debugIndicator = document.getElementById('debug-indicator');
    const runStatus = document.getElementById('run-status');
    const consoleOutput = document.getElementById('console-output');
    const editorPanel = document.getElementById('editor-panel');
    const consolePanel = document.getElementById('console-panel');
    const resizeHandle = document.getElementById('resize-handle');
    const fileTabs = document.getElementById('file-tabs');
    const addFileBtn = document.getElementById('add-file-btn');
    const tabsScrollLeft = document.getElementById('tabs-scroll-left');
    const tabsScrollRight = document.getElementById('tabs-scroll-right');

    // Default code (Romanian pseudocode syntax)
    const defaultCode = `# Implementarea problemei FizzBuzz in pseudocod

# Se primeste ca input un numar, n, si afiseaza toate numerele de la 1 la n astfel:
#   - daca numarul este divizibil cu 3 se afiseaza 'Fizz'
#   - daca numarul este divizibil cu 5 se afiseaza 'Buzz'
#   - daca numarul este divizibil si cu 3 si cu 5 se afiseaza 'FizzBuzz'
#   - in restul cazurilor se afiseaza numarul

scrie "Introduceti valoarea lui n: "
citeste n

daca n < 1 atunci
    scrie "Numarul trebuie sa fie mai mare sau egal cu 1"
altfel
    pentru numar <- 1, n executa
        daca numar % 3 = 0 SI numar % 5 = 0 atunci
            scrie "FizzBuzz"
        altfel
            daca numar % 3 = 0 atunci
                scrie "Fizz"
            altfel
                daca numar % 5 = 0 atunci
                    scrie "Buzz"
                altfel
                    scrie numar
                sf
            sf
        sf
    sf
sf`;

    // Gruvbox Dark theme for Monaco
    const gruvboxTheme = {
      base: 'vs-dark',
      inherit: true,
      rules: [
        { token: '', foreground: 'ebdbb2', background: '1d2021' },
        { token: 'comment', foreground: '928374', fontStyle: 'italic' },
        { token: 'keyword', foreground: 'fb4934' },
        { token: 'keyword.control', foreground: 'fb4934' },          // daca, pentru, cat, repeta
        { token: 'keyword.flow', foreground: 'fb4934' },             // atunci, altfel, executa, timp, pana, cand, sf
        { token: 'keyword.function', foreground: 'fabd2f' },         // citeste, scrie
        { token: 'keyword.operator', foreground: 'fe8019' },         // SAU, SI, NOT
        { token: 'string', foreground: 'b8bb26' },
        { token: 'number', foreground: 'd3869b' },
        { token: 'operator', foreground: '8ec07c' },
        { token: 'delimiter', foreground: 'ebdbb2' },
        { token: 'delimiter.bracket', foreground: 'fe8019' },        // [ ] for floor
        { token: 'delimiter.parenthesis', foreground: 'ebdbb2' },
        { token: 'variable', foreground: '83a598' },
        { token: 'function', foreground: 'fabd2f' },
        { token: 'type', foreground: 'fabd2f' },
        { token: 'constant', foreground: 'd3869b' },
      ],
      colors: {
        'editor.background': '#1d2021',
        'editor.foreground': '#ebdbb2',
        'editor.lineHighlightBackground': '#32302f',
        'editor.selectionBackground': '#504945',
        'editor.inactiveSelectionBackground': '#3c3836',
        'editorCursor.foreground': '#ebdbb2',
        'editorWhitespace.foreground': '#504945',
        'editorLineNumber.foreground': '#665c54',
        'editorLineNumber.activeForeground': '#ebdbb2',
        'editorIndentGuide.background': '#3c3836',
        'editorIndentGuide.activeBackground': '#504945',
        'editor.selectionHighlightBackground': '#689d6a40',
        'editorBracketMatch.background': '#68986640',
        'editorBracketMatch.border': '#689866',
        'scrollbarSlider.background': '#50494580',
        'scrollbarSlider.hoverBackground': '#665c5480',
        'scrollbarSlider.activeBackground': '#7c6f6480',
      }
    };

    // Initialize Monaco Editor
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

    require(['vs/editor/editor.main'], function () {
      // Register Pseudocode language (Romanian syntax)
      monaco.languages.register({ id: 'pseudocode' });

      monaco.languages.setMonarchTokensProvider('pseudocode', {
        ignoreCase: false,
        // Control keywords (daca, pentru, cat, repeta)
        controlKeywords: ['daca', 'pentru', 'cat', 'repeta'],
        // Flow keywords (atunci, altfel, executa, timp, pana, cand, sf)
        flowKeywords: ['atunci', 'altfel', 'executa', 'timp', 'pana', 'cand', 'sf'],
        // Built-in functions
        builtinFunctions: ['citeste', 'scrie'],
        // Logical operators
        logicalOperators: ['SAU', 'sau', 'SI', 'si', 'NOT', 'not'],
        tokenizer: {
          root: [
            // Comments (# style)
            [/#.*$/, 'comment'],
            // Comments (// style)
            [/\/\/.*$/, 'comment'],

            // Strings
            [/"([^"\\]|\\.)*"/, 'string'],
            [/'([^'\\]|\\.)*'/, 'string'],

            // Numbers
            [/\b\d+(\.\d+)?\b/, 'number'],

            // Assignment operators (use \x2D to avoid --> being parsed as HTML comment)
            [/<->|<-\x2D>/, 'operator'],
            [/<-/, 'operator'],

            // Comparison operators
            [/==|!=|<=|>=|<|>|=/, 'operator'],

            // Arithmetic operators
            [/[+\-*/%√]/, 'operator'],

            // Floor brackets
            [/\[|\]/, 'delimiter.bracket'],

            // Parentheses
            [/[()]/, 'delimiter.parenthesis'],

            // Delimiters
            [/[;,]/, 'delimiter'],

            // Identifiers and keywords
            [/[a-zA-Z_][a-zA-Z0-9_]*/, {
              cases: {
                '@controlKeywords': 'keyword.control',
                '@flowKeywords': 'keyword.flow',
                '@builtinFunctions': 'keyword.function',
                '@logicalOperators': 'keyword.operator',
                '@default': 'variable'
              }
            }],
          ]
        }
      });

      // Language configuration (enables Ctrl+/ for comments, bracket matching, etc.)
      monaco.languages.setLanguageConfiguration('pseudocode', {
        comments: {
          lineComment: '#',
        },
        brackets: [
          ['[', ']'],
          ['(', ')'],
        ],
        autoClosingPairs: [
          { open: '[', close: ']' },
          { open: '(', close: ')' },
          { open: '"', close: '"' },
          { open: "'", close: "'" },
        ],
        surroundingPairs: [
          { open: '[', close: ']' },
          { open: '(', close: ')' },
          { open: '"', close: '"' },
          { open: "'", close: "'" },
        ],
      });

      // Define theme
      monaco.editor.defineTheme('gruvbox-dark', gruvboxTheme);

      // Create editor
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: '',
        language: 'pseudocode',
        theme: 'gruvbox-dark',
        fontFamily: "'JetBrains Mono', monospace",
        fontSize: 14,
        lineHeight: 1.6,
        padding: { top: 16 },
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        renderLineHighlight: 'line',
        cursorBlinking: 'smooth',
        cursorSmoothCaretAnimation: 'on',
        smoothScrolling: true,
        wordWrap: 'on',
        automaticLayout: true,
        lineNumbers: 'on',
        glyphMargin: false,
        folding: false,
        lineDecorationsWidth: 8,
        lineNumbersMinChars: 3,
        overviewRulerBorder: false,
        hideCursorInOverviewRuler: true,
        overviewRulerLanes: 0,
        scrollbar: {
          vertical: 'auto',
          horizontal: 'hidden',
          verticalScrollbarSize: 10,
          horizontalScrollbarSize: 0,
        }
      });

      // Load saved state or initialize with default
      const savedState = loadState();
      if (savedState && savedState.files && savedState.files.length > 0) {
        // Restore saved state
        files = savedState.files;
        activeFileId = savedState.activeFileId;
        fileCounter = savedState.fileCounter || files.length;
        if (savedState.editorWidth) {
          editorWidth = savedState.editorWidth;
        }

        // Render tabs and switch to active file
        renderTabs();
        const activeFile = files.find(f => f.id === activeFileId);
        if (activeFile) {
          editor.setValue(activeFile.content);
        } else if (files.length > 0) {
          activeFileId = files[0].id;
          editor.setValue(files[0].content);
          renderTabs();
        }
      } else {
        // Initialize with default file
        createFile('fizzBuzz.pseudo', defaultCode);
      }

      // Set initial panel widths
      updatePanelWidths();

      // Listen for content changes to auto-save
      editor.onDidChangeModelContent(() => {
        debouncedSave();
      });

      // Save state before page unload
      window.addEventListener('beforeunload', saveState);

      // Initialize WASM interpreter
      pseudoInterpreter = new PseudoInterpreter();
      pseudoInterpreter.init().catch(err => {
        appendToConsole(`Failed to initialize: ${err.message}`, 'error');
      });
    });

    // File management functions
    function createFile(name = null, content = '') {
      fileCounter++;
      const id = `file-${fileCounter}`;
      
      if (!name) {
        name = `untitled-${fileCounter}.pseudo`;
      }

      const file = { id, name, content };
      files.push(file);

      renderTabs();
      switchToFile(id);
      saveState();

      return file;
    }

    function deleteFile(id) {
      if (files.length <= 1) return; // Keep at least one file
      
      const index = files.findIndex(f => f.id === id);
      if (index === -1) return;

      // Save current content before deleting
      if (activeFileId === id && editor) {
        files[index].content = editor.getValue();
      }

      files.splice(index, 1);

      // Switch to another file if we deleted the active one
      if (activeFileId === id) {
        const newIndex = Math.min(index, files.length - 1);
        switchToFile(files[newIndex].id);
      }

      renderTabs();
      saveState();
    }

    function switchToFile(id) {
      // Skip if already on this file
      if (activeFileId === id) return;

      // Save current file content
      if (activeFileId && editor) {
        const currentFile = files.find(f => f.id === activeFileId);
        if (currentFile) {
          currentFile.content = editor.getValue();
        }
      }

      activeFileId = id;
      const file = files.find(f => f.id === id);

      if (file && editor) {
        editor.setValue(file.content);
        editor.focus();
      }

      renderTabs();
      saveState();
    }

    function renameFile(id, newName) {
      const file = files.find(f => f.id === id);
      if (file) {
        file.name = newName.endsWith('.pseudo') ? newName : newName + '.pseudo';
        renderTabs();
        saveState();
      }
    }

    function renderTabs() {
      fileTabs.innerHTML = '';
      
      files.forEach(file => {
        const tab = document.createElement('div');
        tab.className = `file-tab ${file.id === activeFileId ? 'active' : ''}`;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'file-tab-name';
        nameSpan.textContent = file.name;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'file-tab-close';
        closeBtn.title = 'Close file';
        closeBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>`;
        
        tab.appendChild(nameSpan);
        tab.appendChild(closeBtn);

        // Click to switch (but not on close button)
        tab.addEventListener('click', (e) => {
          if (!e.target.closest('.file-tab-close')) {
            switchToFile(file.id);
          }
        });

        // Double-click on name to rename
        nameSpan.addEventListener('dblclick', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const input = document.createElement('input');
          input.type = 'text';
          input.value = file.name.replace('.pseudo', '');
          input.className = 'file-tab-input';
          input.style.cssText = `
            background: var(--bg-hard);
            border: 1px solid var(--blue);
            border-radius: 2px;
            color: var(--fg);
            font-family: inherit;
            font-size: inherit;
            padding: 0 4px;
            width: 80px;
            outline: none;
          `;
          
          nameSpan.style.display = 'none';
          tab.insertBefore(input, closeBtn);
          input.focus();
          input.select();

          let finished = false;
          const finishRename = () => {
            if (finished) return;
            finished = true;
            const newName = input.value.trim() || 'untitled';
            renameFile(file.id, newName);
          };

          input.addEventListener('blur', finishRename);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              finishRename();
            } else if (e.key === 'Escape') {
              finished = true;
              renderTabs();
            }
          });
        });

        // Close button
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteFile(file.id);
        });

        fileTabs.appendChild(tab);
      });
    }

    // Add file button
    addFileBtn.addEventListener('click', () => {
      createFile();
    });

    // Tab scroll functionality
    function updateScrollButtons() {
      const hasOverflow = fileTabs.scrollWidth > fileTabs.clientWidth;
      const canScrollLeft = fileTabs.scrollLeft > 0;
      const canScrollRight = fileTabs.scrollLeft < fileTabs.scrollWidth - fileTabs.clientWidth - 1;

      tabsScrollLeft.classList.toggle('visible', hasOverflow && canScrollLeft);
      tabsScrollRight.classList.toggle('visible', hasOverflow && canScrollRight);
    }

    tabsScrollLeft.addEventListener('click', () => {
      fileTabs.scrollLeft -= 100;
      setTimeout(updateScrollButtons, 150);
    });

    tabsScrollRight.addEventListener('click', () => {
      fileTabs.scrollLeft += 100;
      setTimeout(updateScrollButtons, 150);
    });

    fileTabs.addEventListener('scroll', updateScrollButtons);

    // Resize functionality
    let isDragging = false;

    resizeHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      resizeHandle.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      
      const containerWidth = document.querySelector('.main').offsetWidth;
      const newWidth = (e.clientX / containerWidth) * 100;
      
      // Constrain between 20% and 80%
      editorWidth = Math.max(20, Math.min(80, newWidth));
      updatePanelWidths();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        resizeHandle.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        saveState();
      }
    });

    function updatePanelWidths() {
      editorPanel.style.width = `${editorWidth}%`;
      consolePanel.style.width = `${100 - editorWidth}%`;
    }

    // Console functions
    let outputBuffer = [];
    let flushScheduled = false;

    function clearConsole() {
      outputBuffer = [];
      consoleOutput.innerHTML = '<div class="console-placeholder">$ ready</div>';
    }

    function flushOutputBuffer() {
      if (outputBuffer.length === 0) {
        flushScheduled = false;
        return;
      }

      // Remove placeholder if present
      const placeholder = consoleOutput.querySelector('.console-placeholder');
      if (placeholder) placeholder.remove();

      // Create a document fragment for batch insertion
      const fragment = document.createDocumentFragment();
      for (const item of outputBuffer) {
        const line = document.createElement('div');
        line.className = `console-line ${item.type}`;
        line.textContent = item.content;
        fragment.appendChild(line);
      }
      outputBuffer = [];

      // Insert before input line if it exists, otherwise append
      const existingInput = consoleOutput.querySelector('.input-line');
      if (existingInput) {
        consoleOutput.insertBefore(fragment, existingInput);
      } else {
        consoleOutput.appendChild(fragment);
      }
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      flushScheduled = false;
    }

    function appendToConsole(content, type = 'output') {
      outputBuffer.push({ content, type });

      if (!flushScheduled) {
        flushScheduled = true;
        requestAnimationFrame(flushOutputBuffer);
      }
    }

    function showInputPrompt() {
      // Flush any pending output first
      flushOutputBuffer();

      // Remove placeholder if present
      const placeholder = consoleOutput.querySelector('.console-placeholder');
      if (placeholder) placeholder.remove();

      const inputLine = document.createElement('div');
      inputLine.className = 'input-line';
      inputLine.innerHTML = `
        <span class="input-prompt">></span>
        <input type="text" class="console-input" autofocus>
        <span class="cursor-blink">_</span>
      `;
      consoleOutput.appendChild(inputLine);

      const input = inputLine.querySelector('.console-input');
      input.focus();

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const value = input.value;
          inputLine.remove();
          appendToConsole(value, 'input');
          isWaitingForInput = false;
          if (inputCallback) {
            inputCallback(value);
            inputCallback = null;
          }
        }
      });

      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    // Click console to focus input
    consoleOutput.addEventListener('click', () => {
      const input = consoleOutput.querySelector('.console-input');
      if (input) input.focus();
    });

    // Simple pseudocode interpreter
    async function runCode(debug = false) {
      if (isRunning) return;

      const code = editor.getValue();
      isRunning = true;
      isDebugging = debug;
      stopRequested = false;

      // Update UI
      btnRun.style.display = 'none';
      btnDebug.style.display = 'none';
      btnStop.style.display = 'flex';
      debugIndicator.style.display = debug ? 'inline' : 'none';
      runStatus.textContent = debug ? 'Debugging...' : 'Running...';

      clearConsole();
      appendToConsole('Program started.', 'system');

      try {
        await interpret(code, debug);
        if (!stopRequested) {
          appendToConsole('Program finished.', 'system');
        }
      } catch (err) {
        appendToConsole(`Error: ${err.message}`, 'error');
      }

      // Reset UI
      isRunning = false;
      btnRun.style.display = 'flex';
      btnDebug.style.display = 'flex';
      btnStop.style.display = 'none';
      debugIndicator.style.display = 'none';
      runStatus.textContent = '';
    }

    function stopCode() {
      stopRequested = true;
      isRunning = false;
      isWaitingForInput = false;
      inputCallback = null;

      // Stop the WASM interpreter
      if (pseudoInterpreter) {
        pseudoInterpreter.stop();
      }

      // Remove any input prompts
      const inputLine = consoleOutput.querySelector('.input-line');
      if (inputLine) inputLine.remove();

      appendToConsole('Program stopped.', 'system');

      // Reset UI
      btnRun.style.display = 'flex';
      btnDebug.style.display = 'flex';
      btnStop.style.display = 'none';
      debugIndicator.style.display = 'none';
      runStatus.textContent = '';
    }

    // WASM-based interpreter
    async function interpret(code, debug) {
      if (!pseudoInterpreter || !pseudoInterpreter.initialized) {
        appendToConsole('WASM interpreter not ready. Please wait...', 'error');
        return;
      }

      // Helper to wait for user input
      function waitForInput() {
        return new Promise((resolve) => {
          isWaitingForInput = true;
          inputCallback = resolve;
          showInputPrompt();
        });
      }

      await pseudoInterpreter.run(code, {
        onOutput: (text) => {
          appendToConsole(text);
        },
        onError: (err) => {
          appendToConsole(`Error: ${err}`, 'error');
        },
        onNeedsInput: async () => {
          if (debug) {
            appendToConsole('Waiting for input...', 'debug');
          }
          const value = await waitForInput();
          return value;
        },
        onStep: (line) => {
          if (debug) {
            appendToConsole(`Line ${line + 1}`, 'debug');
          }
        },
        debug: debug
      });
    }

    // Event listeners
    btnRun.addEventListener('click', () => runCode(false));
    btnDebug.addEventListener('click', () => runCode(true));
    btnStop.addEventListener('click', stopCode);
    btnClear.addEventListener('click', clearConsole);
  </script>
</body>
</html>
